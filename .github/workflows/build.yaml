name: CHIP wheels build (ARMv7)

on:
  push:
  workflow_dispatch:

env:
  # Pin to an OFFICIAL Matter SDK release tag
  MATTER_SDK_REF: v1.3.0.0
  PYTHON_VERSION: "3.11"

jobs:
  build_prepare:
    name: Prepare Matter SDK
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout build repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version
        id: version
        shell: bash
        run: |
          version=$(echo "${GITHUB_REF#refs/*/}")
          if [[ "${version}" =~ ^(main|dev)$ ]]; then
            today="$(date --utc '+%Y.%-m.dev%-d')"
            count="$(git rev-list --count HEAD)"
            version="${today}.${count}"
          fi
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "Building chip-core version ${version}"

      - name: Install host dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git gcc g++ pkg-config \
            libssl-dev libdbus-1-dev libglib2.0-dev \
            libavahi-client-dev ninja-build \
            python3-venv python3-dev python3-pip \
            unzip zstd

      - name: Checkout Matter SDK
        uses: actions/checkout@v4
        with:
          repository: project-chip/connectedhomeip
          ref: ${{ env.MATTER_SDK_REF }}
          path: project-chip

      - name: Checkout submodules
        working-directory: project-chip
        run: scripts/checkout_submodules.py --shallow --platform linux

      - name: Bootstrap Matter SDK
        working-directory: project-chip
        run: bash scripts/bootstrap.sh

      - name: ZAP code pre-generation
        working-directory: project-chip
        run: scripts/run_in_build_env.sh "scripts/codepregen.py ./zzz_pregenerated/"

      - name: Archive Matter SDK
        run: |
          tar -caf project-chip.tar.zst \
            --exclude project-chip/.environment \
            --use-compress-program=zstdmt \
            project-chip

      - name: Upload Matter SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: matter-sdk
          path: project-chip.tar.zst

  build_linux_armv7:
    name: Build chip-core wheel (ARMv7)
    needs: build_prepare
    runs-on: ubuntu-latest

    container:
      image: damienkastner/chip-build-crosscompile-armhf:0.6.25
      options: >
        --sysctl net.ipv6.conf.all.disable_ipv6=0
        --sysctl net.ipv4.conf.all.forwarding=1
        --sysctl net.ipv6.conf.all.forwarding=1

    defaults:
      run:
        shell: bash

    steps:
      - name: Install container deps
        run: |
          apt-get update
          apt-get install -y zstd git

      - name: Restore Matter SDK
        uses: actions/download-artifact@v4
        with:
          name: matter-sdk

      - name: Extract Matter SDK
        run: |
          mkdir -p project-chip
          tar -xaf project-chip.tar.zst --use-compress-program=zstdmt
          git config --global --add safe.directory "*"

      - name: Generate GN build
        working-directory: project-chip
        run: |
          scripts/build/gn_gen.sh --args=" \
            target_os=\"linux\" \
            target_cpu=\"arm\" \
            sysroot=\"/opt/raspberry-buster-armhf-sysroot\" \
            enable_rtti=true \
            chip_crypto=\"boringssl\" \
            chip_mdns=\"platform\" \
            chip_enable_ble=true \
            treat_warnings_as_errors=false \
            chip_python_version=\"${{ needs.build_prepare.outputs.version }}\" \
            chip_python_package_prefix=\"chip\" \
          "

      - name: Build Python controller (chip-core)
        working-directory: project-chip
        run: |
          scripts/run_in_build_env.sh \
          "ninja -C out/controller/python chip-controller"

      - name: Upload ARMv7 wheels
        uses: actions/upload-artifact@v4
        with:
          name: chip-core-armv7-wheels
          path: project-chip/out/controller/python/*.whl

      - name: Publish wheels to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: project-chip/out/controller/python/*.whl
